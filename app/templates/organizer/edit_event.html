{% extends "base.html" %}
{% block title %}Edit Event - EventHub{% endblock %}
{% block page_title %}Edit Event{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div class="breadcrumb">
            <a href="{{ url_for('organizer.dashboard') }}">Dashboard</a>
            <span>/</span>
            <a href="{{ url_for('organizer.my_events') }}">My Events</a>
            <span>/</span>
            <a href="{{ url_for('organizer.event_details', event_id=event.id) }}">{{ event.title[:30] }}</a>
            <span>/</span>
            <span>Edit</span>
        </div>
        <h1>Edit Event</h1>
        <p>Update the details for your event</p>
    </div>

    <div class="form-container">
        <form method="POST"
              action="{{ url_for('organizer.edit_event', event_id=event.id) }}"
              enctype="multipart/form-data"
              id="edit-event-form">

            <!-- ── Basic Information ──────────────────────────────────────── -->
            <div class="form-section">
                <h2 class="section-title">Basic Information</h2>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="title" class="required">Event Title</label>
                        <input type="text" id="title" name="title" class="form-control"
                               value="{{ event.title }}" required maxlength="200">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="category" class="required">Category</label>
                        <select id="category" name="category" class="form-control" required>
                            {% for cat in ['workshop','seminar','conference','cultural','sports','networking','hackathon','webinar','other'] %}
                            <option value="{{ cat }}" {{ 'selected' if event.category == cat }}>
                                {{ cat|title }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="event_type">Event Type</label>
                        <select id="event_type" name="event_type" class="form-control">
                            <option value="in-person" {{ 'selected' if event.event_type == 'in-person' }}>In-Person</option>
                            <option value="online"    {{ 'selected' if event.event_type == 'online' }}>Online</option>
                            <option value="hybrid"    {{ 'selected' if event.event_type == 'hybrid' }}>Hybrid</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="description" class="required">Description</label>
                        <textarea id="description" name="description" class="form-control"
                                  rows="6" required maxlength="2000">{{ event.description }}</textarea>
                        <span class="field-hint" id="char-count">
                            {{ event.description|length }} / 2000 characters
                        </span>
                    </div>
                </div>

                <!-- Banner image -->
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Event Banner Image</label>
                        {% set banner_src = event.banner_url if event.banner_url else
                            (url_for('static', filename='uploads/events/' + event.image) if event.image else None) %}
                        {% if banner_src %}
                        <div class="current-banner">
                            <img src="{{ banner_src }}" alt="Current banner" class="current-banner-img">
                            <span class="current-label">Current banner</span>
                        </div>
                        {% endif %}
                        <div class="image-upload-area" id="image-upload-area">
                            <input type="file" id="event_image" name="event_image"
                                   accept="image/jpeg,image/png,image/jpg,image/webp" hidden>
                            <div class="upload-placeholder" id="upload-placeholder">
                                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                <p>Click to upload a new banner</p>
                                <span>PNG, JPG, WEBP up to 5 MB</span>
                            </div>
                            <div class="image-preview" id="image-preview" style="display:none;">
                                <img id="preview-img" src="" alt="Preview">
                                <button type="button" class="remove-image" id="remove-image">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        <span class="field-hint">Leave empty to keep the current banner</span>
                    </div>
                </div>
            </div>

            <!-- ── Date & Time ────────────────────────────────────────────── -->
            <div class="form-section">
                <h2 class="section-title">Date & Time</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="event_date" class="required">Event Date & Time</label>
                        <input type="text" id="event_date" name="event_date"
                               class="form-control flatpickr-input"
                               value="{{ event.event_date.strftime('%Y-%m-%dT%H:%M') }}"
                               placeholder="Select date and time" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="registration_deadline" class="required">Registration Deadline</label>
                        <input type="text" id="registration_deadline" name="registration_deadline"
                               class="form-control flatpickr-input"
                               value="{{ event.registration_deadline.strftime('%Y-%m-%dT%H:%M') }}"
                               placeholder="Select deadline" required readonly>
                        <span class="field-hint">Must be before event date</span>
                    </div>
                </div>
            </div>

            <!-- ── Location ───────────────────────────────────────────────── -->
            <div class="form-section">
                <h2 class="section-title">Location</h2>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="location" class="required">Venue / Location</label>
                        <input type="text" id="location" name="location" class="form-control"
                               value="{{ event.location }}" required maxlength="200">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="meeting_link">Online Meeting Link</label>
                        <input type="url" id="meeting_link" name="meeting_link" class="form-control"
                               value="{{ event.meeting_link or '' }}"
                               placeholder="https://meet.google.com/...">
                    </div>
                </div>
            </div>

            <!-- ── Capacity & Pricing ─────────────────────────────────────── -->
            <div class="form-section">
                <h2 class="section-title">Capacity & Pricing</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="max_participants" class="required">Maximum Participants</label>
                        <input type="number" id="max_participants" name="max_participants"
                               class="form-control" value="{{ event.max_participants }}" min="1" required>
                        <span class="field-hint">
                            {{ event.max_participants - (event.available_seats or 0) }} already confirmed
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="is_paid">Registration Type</label>
                        <select id="is_paid" name="is_paid" class="form-control">
                            <option value="off" {{ 'selected' if not event.is_paid }}>Free</option>
                            <option value="on"  {{ 'selected' if event.is_paid }}>Paid</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" id="price-field"
                     style="{{ '' if event.is_paid else 'display:none' }}">
                    <div class="form-group">
                        <label for="price" class="required">Price (INR)</label>
                        <input type="number" id="price" name="price" class="form-control"
                               value="{{ event.price or '' }}" min="0" step="0.01">
                    </div>
                    <div class="form-group"></div>
                </div>
            </div>

            <!-- ── Settings ───────────────────────────────────────────────── -->
            <!--
                BUG FIX: this entire section was missing from the original edit form.
                Without it, allow_waitlist and is_public could never be changed
                after creation — the waitlist button would never appear for full events.
            -->
            <div class="form-section">
                <h2 class="section-title">Settings</h2>
                <div class="toggles-grid">

                    <!-- Allow Waitlist -->
                    <label class="toggle-row" for="allow_waitlist">
                        <div class="toggle-text">
                            <span class="toggle-title">
                                <i class="fas fa-list" style="color:#fb923c;"></i>
                                Allow Waitlist
                            </span>
                            <span class="toggle-desc">
                                Participants can join a waitlist when the event is full.
                                They'll be promoted automatically when a seat opens.
                            </span>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="allow_waitlist" name="allow_waitlist"
                                   {{ 'checked' if event.allow_waitlist }}>
                            <span class="toggle-track">
                                <span class="toggle-thumb"></span>
                            </span>
                        </div>
                    </label>

                    <!-- Public Event -->
                    <label class="toggle-row" for="is_public">
                        <div class="toggle-text">
                            <span class="toggle-title">
                                <i class="fas fa-globe" style="color:#4da6ff;"></i>
                                Public Event
                            </span>
                            <span class="toggle-desc">
                                Visible to all participants in the browse listing.
                                Uncheck to make it invite-only.
                            </span>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="is_public" name="is_public"
                                   {{ 'checked' if event.is_public }}>
                            <span class="toggle-track">
                                <span class="toggle-thumb"></span>
                            </span>
                        </div>
                    </label>

                    <!-- Send Reminders -->
                    <label class="toggle-row" for="send_reminders">
                        <div class="toggle-text">
                            <span class="toggle-title">
                                <i class="fas fa-bell" style="color:#a855f7;"></i>
                                Send Reminders
                            </span>
                            <span class="toggle-desc">
                                Send email reminders to registered participants 24 hours before the event.
                            </span>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="send_reminders" name="send_reminders"
                                   {{ 'checked' if event.send_reminders }}>
                            <span class="toggle-track">
                                <span class="toggle-thumb"></span>
                            </span>
                        </div>
                    </label>

                </div>
            </div>

            <!-- ── Form Actions ───────────────────────────────────────────── -->
            <div class="form-actions">
                <a href="{{ url_for('organizer.event_details', event_id=event.id) }}"
                   class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary" id="submit-btn">
                    <i class="fas fa-save"></i> Update Event
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.page-container  { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
.page-header     { margin-bottom: 32px; }
.breadcrumb {
    display: flex; align-items: center; gap: 8px;
    font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;
}
.breadcrumb a { color: var(--accent); text-decoration: none; }
.page-header h1 { font-size: 32px; font-weight: 700; margin-bottom: 6px; }
.page-header p  { color: var(--text-secondary); }

.form-container { background: var(--bg-elevated); border-radius: 16px; padding: 40px; }
.form-section {
    margin-bottom: 40px; padding-bottom: 40px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
}
.form-section:last-of-type { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
.section-title { font-size: 18px; font-weight: 700; margin-bottom: 24px; }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.form-row:last-child { margin-bottom: 0; }
.form-group { display: flex; flex-direction: column; gap: 8px; }
.form-group.full-width { grid-column: 1 / -1; }
.form-group label { font-size: 14px; font-weight: 600; }
.form-group label.required::after { content: '*'; color: #ef4444; margin-left: 4px; }

.form-control {
    width: 100%; padding: 12px 16px; background: var(--bg-base);
    border: 1px solid rgba(255,255,255,0.08); border-radius: 8px;
    font-size: 15px; color: var(--text-primary); font-family: inherit;
    transition: all 0.2s; box-sizing: border-box;
}
.form-control:focus {
    outline: none; border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(77,166,255,0.1);
}
.form-control[readonly] { cursor: pointer; }
.form-control[readonly]:hover { border-color: var(--accent); }
textarea.form-control { resize: vertical; min-height: 100px; }
.field-hint { font-size: 12px; color: var(--text-tertiary); }

/* Banner */
.current-banner { margin-bottom: 12px; }
.current-banner-img {
    width: 100%; height: 200px; object-fit: cover;
    object-position: center top; border-radius: 10px;
}
.current-label { font-size: 12px; color: var(--text-tertiary); display: block; margin-top: 6px; }

/* Image upload */
.image-upload-area {
    border: 2px dashed rgba(255,255,255,0.1); border-radius: 12px;
    overflow: hidden; transition: all 0.3s; cursor: pointer;
}
.image-upload-area:hover { border-color: var(--accent); }
.upload-placeholder { padding: 40px 20px; text-align: center; }
.upload-icon { font-size: 40px; color: var(--text-tertiary); margin-bottom: 12px; display: block; }
.upload-placeholder p    { font-size: 15px; font-weight: 500; margin-bottom: 6px; }
.upload-placeholder span { font-size: 13px; color: var(--text-secondary); }
.image-preview { position: relative; }
.image-preview img { width: 100%; height: 200px; object-fit: cover; display: block; }
.remove-image {
    position: absolute; top: 10px; right: 10px; width: 34px; height: 34px;
    background: rgba(0,0,0,0.7); border: none; border-radius: 8px;
    color: white; cursor: pointer; display: flex; align-items: center;
    justify-content: center; transition: background 0.2s;
}
.remove-image:hover { background: #ef4444; }

/* ── Settings toggles ────────────────────────────────────────────── */
.toggles-grid { display: flex; flex-direction: column; gap: 16px; }

.toggle-row {
    display: flex; align-items: center; justify-content: space-between;
    gap: 20px; padding: 18px 20px; border-radius: 12px;
    background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);
    cursor: pointer; transition: border-color 0.2s;
}
.toggle-row:hover { border-color: rgba(77,166,255,0.2); }

.toggle-text { flex: 1; min-width: 0; }
.toggle-title {
    display: flex; align-items: center; gap: 8px;
    font-size: 15px; font-weight: 600; margin-bottom: 4px;
}
.toggle-desc { font-size: 13px; color: var(--text-secondary); line-height: 1.4; }

/* Hide native checkbox — custom track/thumb used instead */
.toggle-switch input[type="checkbox"] { display: none; }
.toggle-track {
    display: block; width: 44px; height: 24px; border-radius: 12px;
    background: rgba(255,255,255,0.1); position: relative;
    transition: background 0.25s; flex-shrink: 0;
    border: 1px solid rgba(255,255,255,0.12);
}
.toggle-thumb {
    position: absolute; top: 3px; left: 3px;
    width: 16px; height: 16px; border-radius: 50%;
    background: rgba(255,255,255,0.5); transition: transform 0.25s, background 0.25s;
}
/* Checked state — driven by sibling CSS */
.toggle-switch input:checked + .toggle-track { background: var(--accent); border-color: var(--accent); }
.toggle-switch input:checked + .toggle-track .toggle-thumb {
    transform: translateX(20px); background: white;
}

/* Flatpickr dark theme */
.flatpickr-calendar { background: #1e293b !important; border: 1px solid rgba(255,255,255,0.1) !important; border-radius: 12px !important; box-shadow: 0 8px 30px rgba(0,0,0,0.5) !important; }
.flatpickr-month, .flatpickr-weekdays, .flatpickr-time { background: #1e293b !important; }
.flatpickr-current-month, .flatpickr-current-month .cur-month,
.flatpickr-current-month input.cur-year { color: #e2e8f0 !important; }
.flatpickr-day { color: #e2e8f0 !important; border-radius: 8px !important; }
.flatpickr-day:hover { background: rgba(77,166,255,0.15) !important; border-color: transparent !important; color: #4da6ff !important; }
.flatpickr-day.selected, .flatpickr-day.selected:hover { background: #4da6ff !important; border-color: #4da6ff !important; color: white !important; }
.flatpickr-day.today  { border-color: #4da6ff !important; color: #4da6ff !important; }
.flatpickr-day.disabled { color: #334155 !important; }
.flatpickr-weekday    { background: #1e293b !important; color: #64748b !important; }
.flatpickr-time input, .flatpickr-time .flatpickr-am-pm { color: #e2e8f0 !important; background: transparent !important; font-weight: 600 !important; }
.flatpickr-time { border-top: 1px solid rgba(255,255,255,0.08) !important; }

/* Buttons */
.form-actions {
    display: flex; justify-content: flex-end; gap: 12px;
    margin-top: 40px; padding-top: 32px;
    border-top: 1px solid rgba(255,255,255,0.06);
}
.btn {
    padding: 12px 24px; border-radius: 8px; font-size: 15px; font-weight: 600;
    cursor: pointer; border: none; display: inline-flex; align-items: center;
    gap: 8px; transition: all 0.2s; text-decoration: none;
}
.btn-primary   { background: var(--accent); color: white; }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(77,166,255,0.35); }
.btn-secondary { background: var(--bg-base); color: var(--text-primary); border: 1px solid rgba(255,255,255,0.1); }
.btn-secondary:hover { border-color: rgba(255,255,255,0.2); }

@media (max-width: 768px) {
    .form-container { padding: 24px; }
    .form-row       { grid-template-columns: 1fr; }
    .form-actions   { flex-direction: column-reverse; }
    .btn            { width: 100%; justify-content: center; }
    .toggle-row     { flex-direction: column; align-items: flex-start; }
}
</style>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {

    // Datetime pickers
    flatpickr('#event_date', {
        enableTime: true, dateFormat: 'Y-m-d\\TH:i',
        minDate: 'today', time_24hr: true, disableMobile: true
    });
    flatpickr('#registration_deadline', {
        enableTime: true, dateFormat: 'Y-m-d\\TH:i',
        minDate: 'today', time_24hr: true, disableMobile: true
    });

    // Char counter
    var desc = document.getElementById('description');
    var cc   = document.getElementById('char-count');
    if (desc && cc) {
        desc.addEventListener('input', function () {
            var n = this.value.length;
            cc.textContent  = n + ' / 2000 characters';
            cc.style.color  = n > 1900 ? '#ef4444' : 'var(--text-tertiary)';
        });
    }

    // Paid/Free toggle
    var isPaid = document.getElementById('is_paid');
    var pf     = document.getElementById('price-field');
    if (isPaid && pf) {
        isPaid.addEventListener('change', function () {
            pf.style.display = this.value === 'on' ? '' : 'none';
        });
    }

    // Image upload preview
    var input    = document.getElementById('event_image');
    var area     = document.getElementById('image-upload-area');
    var ph       = document.getElementById('upload-placeholder');
    var preview  = document.getElementById('image-preview');
    var pimg     = document.getElementById('preview-img');
    var removBtn = document.getElementById('remove-image');

    if (ph)    ph.addEventListener('click', () => input.click());
    if (input) {
        input.addEventListener('change', function (e) {
            var file = e.target.files[0];
            if (!file) return;
            if (!file.type.match('image/(jpeg|jpg|png|webp)')) {
                alert('Please upload JPEG, PNG or WEBP'); this.value = ''; return;
            }
            if (file.size > 5 * 1024 * 1024) {
                alert('Max file size is 5 MB'); this.value = ''; return;
            }
            var r = new FileReader();
            r.onload = function (ev) {
                pimg.src = ev.target.result;
                ph.style.display      = 'none';
                preview.style.display = 'block';
            };
            r.readAsDataURL(file);
        });
    }
    if (removBtn) {
        removBtn.addEventListener('click', function () {
            input.value = ''; pimg.src = '';
            ph.style.display      = 'block';
            preview.style.display = 'none';
        });
    }

    // Drag and drop
    if (area) {
        area.addEventListener('dragover',  e => { e.preventDefault(); area.style.borderColor = 'var(--accent)'; });
        area.addEventListener('dragleave', e => { e.preventDefault(); area.style.borderColor = 'rgba(255,255,255,0.1)'; });
        area.addEventListener('drop', function (e) {
            e.preventDefault();
            area.style.borderColor = 'rgba(255,255,255,0.1)';
            var file = e.dataTransfer.files[0];
            if (!file || !file.type.match('image/(jpeg|jpg|png|webp)')) {
                alert('Please upload JPEG, PNG or WEBP'); return;
            }
            var dt = new DataTransfer();
            dt.items.add(file);
            input.files = dt.files;
            input.dispatchEvent(new Event('change'));
        });
    }

    // Submit loading state
    document.getElementById('edit-event-form').addEventListener('submit', function () {
        var btn = document.getElementById('submit-btn');
        btn.disabled    = true;
        btn.innerHTML   = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    });
});
</script>
{% endblock %}
{% endblock %}
