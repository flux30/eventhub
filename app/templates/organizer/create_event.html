{% extends "base.html" %}

{% block title %}Create Event - EventHub{% endblock %}

{% block page_title %}Create Event{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div class="header-content">
            <div class="breadcrumb">
                <a href="{{ url_for('organizer.dashboard') }}">Dashboard</a>
                <span>/</span>
                <a href="{{ url_for('organizer.my_events') }}">Events</a>
                <span>/</span>
                <span>Create Event</span>
            </div>
            <h1>Create New Event</h1>
            <p>Fill in the details to create your event</p>
        </div>
    </div>

    <div class="form-container">
        <form method="POST" enctype="multipart/form-data" id="create-event-form" class="event-form">
            <!-- Basic Information -->
            <div class="form-section">
                <h2 class="section-title">Basic Information</h2>
                
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="title" class="required">Event Title</label>
                        <input type="text" id="title" name="title" class="form-control" 
                               placeholder="Enter event title" required maxlength="200">
                        <span class="field-hint">Make it clear and descriptive</span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="category" class="required">Category</label>
                        <select id="category" name="category" class="form-control" required>
                            <option value="">Select category</option>
                            <option value="workshop">Workshop</option>
                            <option value="seminar">Seminar</option>
                            <option value="conference">Conference</option>
                            <option value="cultural">Cultural</option>
                            <option value="sports">Sports</option>
                            <option value="networking">Networking</option>
                            <option value="hackathon">Hackathon</option>
                            <option value="webinar">Webinar</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="event_type">Event Type</label>
                        <select id="event_type" name="event_type" class="form-control">
                            <option value="in-person">In-Person</option>
                            <option value="online">Online</option>
                            <option value="hybrid">Hybrid</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="description" class="required">Description</label>
                        <textarea id="description" name="description" class="form-control" rows="6"
                                  placeholder="Describe your event..." required maxlength="2000"></textarea>
                        <span class="field-hint" id="char-count">0 / 2000 characters</span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="event_image">Event Banner Image</label>
                        <div class="image-upload-area" id="image-upload-area">
                            <input type="file" id="event_image" name="event_image" 
                                   accept="image/jpeg,image/png,image/jpg" hidden>
                            <div class="upload-placeholder" id="upload-placeholder">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 22H15C20 22 22 20 22 15V9C22 4 20 2 15 2H9C4 2 2 4 2 9V15C2 20 4 22 9 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M9 10C10.1046 10 11 9.10457 11 8C11 6.89543 10.1046 6 9 6C7.89543 6 7 6.89543 7 8C7 9.10457 7.89543 10 9 10Z" stroke="currentColor" stroke-width="1.5"/>
                                    <path d="M2.67004 18.9501L7.60004 15.6401C8.39004 15.1101 9.53004 15.1701 10.24 15.7801L10.57 16.0701C11.35 16.7401 12.61 16.7401 13.39 16.0701L17.55 12.5001C18.33 11.8301 19.59 11.8301 20.37 12.5001L22 13.9001" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                                <p>Click to upload or drag and drop</p>
                                <span>PNG, JPG up to 5MB (1920x1080 recommended)</span>
                            </div>
                            <div class="image-preview" id="image-preview" style="display: none;">
                                <img id="preview-img" src="" alt="Preview">
                                <button type="button" class="remove-image" id="remove-image">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                        <path d="M21 5.98047C17.67 5.65047 14.32 5.48047 10.98 5.48047C9 5.48047 7.02 5.58047 5.04 5.78047L3 5.98047" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                        <path d="M8.5 4.97L8.72 3.66C8.88 2.71 9 2 10.69 2H13.31C15 2 15.13 2.75 15.28 3.67L15.5 4.97" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                        <path d="M18.85 9.14062L18.2 19.2106C18.09 20.7806 18 22.0006 15.21 22.0006H8.79002C6.00002 22.0006 5.91002 20.7806 5.80002 19.2106L5.15002 9.14062" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <span class="field-hint">Optional - A banner image makes your event more attractive</span>
                    </div>
                </div>
            </div>

            <!-- Date & Time -->
            <div class="form-section">
                <h2 class="section-title">Date & Time</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="event_date" class="required">Event Date</label>
                        <!-- ✅ type="text" + readonly for Flatpickr -->
                        <input type="text" id="event_date" name="event_date" 
                               class="form-control flatpickr-input"
                               placeholder="Select event date" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="event_time" class="required">Event Time</label>
                        <!-- ✅ type="text" + readonly for Flatpickr -->
                        <input type="text" id="event_time" name="event_time" 
                               class="form-control flatpickr-input"
                               placeholder="Select event time" required readonly>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="registration_deadline" class="required">Registration Deadline</label>
                        <!-- ✅ type="text" + readonly for Flatpickr -->
                        <input type="text" id="registration_deadline" name="registration_deadline" 
                               class="form-control flatpickr-input"
                               placeholder="Select deadline" required readonly>
                        <span class="field-hint">Must be before event date</span>
                    </div>

                    <div class="form-group">
                        <label for="duration">Duration (hours)</label>
                        <input type="number" id="duration" name="duration" class="form-control" 
                               placeholder="2" min="0.5" step="0.5">
                    </div>
                </div>
            </div>

            <!-- Location -->
            <div class="form-section">
                <h2 class="section-title">Location</h2>
                
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="location" class="required">Venue / Location</label>
                        <input type="text" id="location" name="location" class="form-control" 
                               placeholder="e.g., Main Auditorium, Building A or Zoom Meeting"
                               required maxlength="200">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="meeting_link">Online Meeting Link</label>
                        <input type="url" id="meeting_link" name="meeting_link" class="form-control" 
                               placeholder="https://zoom.us/j/...">
                        <span class="field-hint">For online or hybrid events</span>
                    </div>
                </div>
            </div>

            <!-- Capacity & Registration -->
            <div class="form-section">
                <h2 class="section-title">Capacity & Registration</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="max_participants" class="required">Maximum Participants</label>
                        <input type="number" id="max_participants" name="max_participants" 
                               class="form-control" placeholder="100" min="1" required>
                    </div>

                    <div class="form-group">
                        <label for="min_participants">Minimum Participants</label>
                        <input type="number" id="min_participants" name="min_participants" 
                               class="form-control" placeholder="10" min="0">
                        <span class="field-hint">Optional</span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="is_paid">Registration Type</label>
                        <select id="is_paid" name="is_paid" class="form-control">
                            <option value="0">Free</option>
                            <option value="1">Paid</option>
                        </select>
                    </div>

                    <div class="form-group" id="price-field" style="display: none;">
                        <label for="price" class="required">Price (INR)</label>
                        <input type="number" id="price" name="price" class="form-control" 
                               placeholder="500" min="0" step="0.01">
                    </div>
                </div>
            </div>

            <!-- Additional Details -->
            <div class="form-section">
                <h2 class="section-title">Additional Details</h2>
                
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="tags">Tags (comma-separated)</label>
                        <input type="text" id="tags" name="tags" class="form-control" 
                               placeholder="python, ai, machine learning">
                        <span class="field-hint">Help people find your event</span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="requirements">Requirements / Prerequisites</label>
                        <textarea id="requirements" name="requirements" class="form-control" rows="3"
                                  placeholder="List any requirements or things participants should bring..."></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="send_reminders" checked>
                            <span>Send email reminders to participants</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="allow_waitlist">
                            <span>Enable waitlist when event is full</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="is_public" checked>
                            <span>Make event publicly visible</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <a href="{{ url_for('organizer.my_events') }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary" id="submit-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M12 22C17.5 22 22 17.5 22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7.75 12L10.58 14.83L16.25 9.17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Create Event
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.page-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
}

.page-header { margin-bottom: 40px; }

.breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 16px;
}

.breadcrumb a {
    color: var(--accent);
    text-decoration: none;
    transition: opacity 0.2s;
}

.breadcrumb a:hover { opacity: 0.8; }

.breadcrumb span:not(:last-child) { color: var(--text-tertiary); }

.page-header h1 {
    font-size: 36px;
    font-weight: 700;
    margin-bottom: 8px;
}

.page-header p {
    color: var(--text-secondary);
    font-size: 16px;
}

.form-container {
    background: var(--bg-elevated);
    border-radius: 16px;
    padding: 40px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.form-section {
    margin-bottom: 40px;
    padding-bottom: 40px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
}

.form-section:last-of-type {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.section-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 24px;
    color: var(--text-primary);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.form-row:last-child { margin-bottom: 0; }

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group.full-width { grid-column: 1 / -1; }

.form-group label {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
}

.form-group label.required::after {
    content: '*';
    color: #ef4444;
    margin-left: 4px;
}

.form-control {
    width: 100%;
    padding: 12px 16px;
    background: var(--bg-base);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 8px;
    font-size: 15px;
    color: var(--text-primary);
    font-family: inherit;
    transition: all 0.2s;
    box-sizing: border-box;
}

.form-control:hover { border-color: rgba(255, 255, 255, 0.15); }

.form-control:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(77, 166, 255, 0.1);
}

.form-control::placeholder { color: var(--text-tertiary); }

textarea.form-control {
    resize: vertical;
    min-height: 100px;
}

/* ✅ Flatpickr readonly inputs still look clickable */
.form-control[readonly] {
    cursor: pointer;
    background: var(--bg-base);
}

.form-control[readonly]:hover {
    border-color: var(--accent);
}

.field-hint {
    font-size: 12px;
    color: var(--text-tertiary);
}

/* ✅ Flatpickr Dark Theme */
.flatpickr-calendar {
    background: #1e293b !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6) !important;
    border-radius: 12px !important;
    color: #e2e8f0 !important;
}

.flatpickr-months {
    background: #1e293b !important;
    border-radius: 12px 12px 0 0 !important;
}

.flatpickr-month {
    color: #e2e8f0 !important;
    fill: #e2e8f0 !important;
}

.flatpickr-current-month,
.flatpickr-current-month .cur-month,
.flatpickr-current-month input.cur-year {
    color: #e2e8f0 !important;
    font-weight: 600 !important;
}

.flatpickr-prev-month,
.flatpickr-next-month {
    fill: #94a3b8 !important;
    color: #94a3b8 !important;
}

.flatpickr-prev-month:hover svg,
.flatpickr-next-month:hover svg {
    fill: #4da6ff !important;
}

.flatpickr-weekdays {
    background: #1e293b !important;
}

.flatpickr-weekday {
    background: #1e293b !important;
    color: #64748b !important;
    font-weight: 600 !important;
}

.flatpickr-day {
    color: #e2e8f0 !important;
    border-radius: 8px !important;
}

.flatpickr-day:hover {
    background: rgba(77, 166, 255, 0.15) !important;
    border-color: transparent !important;
    color: #4da6ff !important;
}

.flatpickr-day.selected,
.flatpickr-day.selected:hover {
    background: #4da6ff !important;
    border-color: #4da6ff !important;
    color: white !important;
}

.flatpickr-day.today {
    border-color: #4da6ff !important;
    color: #4da6ff !important;
}

.flatpickr-day.today:hover {
    background: #4da6ff !important;
    color: white !important;
}

.flatpickr-day.disabled,
.flatpickr-day.disabled:hover {
    color: #334155 !important;
    cursor: not-allowed !important;
}

.flatpickr-day.prevMonthDay,
.flatpickr-day.nextMonthDay {
    color: #475569 !important;
}

/* Time picker */
.flatpickr-time {
    background: #1e293b !important;
    border-top: 1px solid rgba(255, 255, 255, 0.08) !important;
    border-radius: 0 0 12px 12px !important;
}

.flatpickr-time input,
.flatpickr-time .flatpickr-am-pm {
    color: #e2e8f0 !important;
    background: transparent !important;
    font-size: 16px !important;
    font-weight: 600 !important;
}

.flatpickr-time input:hover,
.flatpickr-time input:focus,
.flatpickr-time .flatpickr-am-pm:hover {
    background: rgba(77, 166, 255, 0.1) !important;
}

.flatpickr-time .numInputWrapper span.arrowUp,
.flatpickr-time .numInputWrapper span.arrowDown {
    border-color: rgba(255,255,255,0.1) !important;
}

/* Image Upload */
.image-upload-area {
    position: relative;
    border: 2px dashed rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s;
}

.image-upload-area:hover {
    border-color: var(--accent);
    background: rgba(77, 166, 255, 0.03);
}

.upload-placeholder {
    padding: 60px 20px;
    text-align: center;
    cursor: pointer;
}

.upload-placeholder svg {
    color: var(--text-tertiary);
    margin-bottom: 16px;
}

.upload-placeholder p {
    font-size: 16px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 8px;
}

.upload-placeholder span {
    font-size: 13px;
    color: var(--text-secondary);
}

.image-preview { position: relative; }

.image-preview img {
    width: 100%;
    height: 300px;
    object-fit: cover;
    display: block;
}

.remove-image {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 36px;
    height: 36px;
    background: rgba(0, 0, 0, 0.7);
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.remove-image:hover {
    background: #ef4444;
    transform: scale(1.1);
}

/* Checkbox Group */
.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-weight: 400;
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

/* Form Actions */
.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 40px;
    padding-top: 40px;
    border-top: 1px solid rgba(255, 255, 255, 0.06);
}

.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    text-decoration: none;
}

.btn-primary { background: var(--accent); color: white; }

.btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(77, 166, 255, 0.4);
}

.btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

.btn-secondary {
    background: var(--bg-base);
    color: var(--text-primary);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-secondary:hover {
    background: var(--bg-elevated);
    border-color: rgba(255, 255, 255, 0.2);
}

.spin { animation: spin 1s linear infinite; }

@keyframes spin { to { transform: rotate(360deg); } }

@media (max-width: 768px) {
    .form-container { padding: 24px; }
    .form-row { grid-template-columns: 1fr; }
    .form-actions { flex-direction: column-reverse; }
    .btn { width: 100%; justify-content: center; }
}
</style>

{% block extra_js %}
<script>
// ✅ Flatpickr initialization - runs AFTER DOM and Flatpickr are loaded
document.addEventListener('DOMContentLoaded', function() {

    // Registration Deadline picker (initialized first, referenced by event date picker)
    var regDeadlinePicker = flatpickr("#registration_deadline", {
        dateFormat: "Y-m-d",
        minDate: "today",
        disableMobile: true,
        onChange: function(selectedDates, dateStr) {
            var eventDateVal = document.getElementById('event_date').value;
            if (eventDateVal && dateStr >= eventDateVal) {
                alert('Registration deadline must be before event date');
                regDeadlinePicker.clear();
            }
        }
    });

    // Event Date picker
    var eventDatePicker = flatpickr("#event_date", {
        dateFormat: "Y-m-d",
        minDate: "today",
        disableMobile: true,
        onChange: function(selectedDates, dateStr) {
            // Update deadline's max allowed date
            regDeadlinePicker.set('maxDate', dateStr);
            // Clear deadline if it's now invalid
            var deadlineVal = document.getElementById('registration_deadline').value;
            if (deadlineVal && deadlineVal >= dateStr) {
                regDeadlinePicker.clear();
                alert('Registration deadline must be before event date');
            }
        }
    });

    // Event Time picker
    flatpickr("#event_time", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
        time_24hr: true,
        disableMobile: true
    });

    // Character counter
    var description = document.getElementById('description');
    var charCount = document.getElementById('char-count');
    if (description) {
        description.addEventListener('input', function() {
            var count = this.value.length;
            charCount.textContent = count + ' / 2000 characters';
            charCount.style.color = count > 1900 ? '#ef4444' : 'var(--text-tertiary)';
        });
    }

    // Show/hide price field
    var isPaid = document.getElementById('is_paid');
    var priceField = document.getElementById('price-field');
    var priceInput = document.getElementById('price');
    if (isPaid) {
        isPaid.addEventListener('change', function() {
            if (this.value === '1') {
                priceField.style.display = 'block';
                priceInput.required = true;
            } else {
                priceField.style.display = 'none';
                priceInput.required = false;
                priceInput.value = '';
            }
        });
    }

    // Image upload
    var imageInput = document.getElementById('event_image');
    var uploadArea = document.getElementById('image-upload-area');
    var uploadPlaceholder = document.getElementById('upload-placeholder');
    var imagePreview = document.getElementById('image-preview');
    var previewImg = document.getElementById('preview-img');
    var removeImageBtn = document.getElementById('remove-image');

    if (uploadPlaceholder) {
        uploadPlaceholder.addEventListener('click', function() {
            imageInput.click();
        });
    }

    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) {
                if (!file.type.match('image/(jpeg|jpg|png)')) {
                    alert('Please upload a valid image file (JPEG, JPG, or PNG)');
                    this.value = '';
                    return;
                }
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size must be less than 5MB');
                    this.value = '';
                    return;
                }
                var reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    uploadPlaceholder.style.display = 'none';
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
    }

    if (removeImageBtn) {
        removeImageBtn.addEventListener('click', function() {
            imageInput.value = '';
            previewImg.src = '';
            uploadPlaceholder.style.display = 'block';
            imagePreview.style.display = 'none';
        });
    }

    // Drag and drop
    if (uploadArea) {
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = 'var(--accent)';
        });
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = 'rgba(255, 255, 255, 0.1)';
        });
        uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.style.borderColor = 'rgba(255, 255, 255, 0.1)';
    var file = e.dataTransfer.files[0];

    if (!file) return;

    // Accept image/jpeg, image/jpg, image/png
    var validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
    if (!validTypes.includes(file.type)) {
        alert('Please upload a valid image file (JPEG or PNG)');
        return;
    }

    if (file.size > 5 * 1024 * 1024) {
        alert('Image size must be less than 5MB');
        return;
    }

    // ✅ Use DataTransfer to assign file to input
    var dt = new DataTransfer();
    dt.items.add(file);
    imageInput.files = dt.files;

    // Trigger preview
    var reader = new FileReader();
    reader.onload = function(e) {
        previewImg.src = e.target.result;
        uploadPlaceholder.style.display = 'none';
        imagePreview.style.display = 'block';
    };
    reader.readAsDataURL(file);
});
    }

    // Form submission
    var form = document.getElementById('create-event-form');
    var submitBtn = document.getElementById('submit-btn');
    if (form) {
        form.addEventListener('submit', function(e) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<svg width="20" height="20" class="spin" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity="0.2"/><path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" stroke-linecap="round"/></svg> Creating...';
        });
    }

});
</script>
{% endblock %}

{% endblock %}
