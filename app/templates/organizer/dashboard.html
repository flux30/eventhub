{% extends "base.html" %}

{% block title %}Organizer Dashboard - EventHub{% endblock %}
{% block page_title %}Organizer Dashboard{% endblock %}

{% block content %}
<!-- Welcome Banner -->
<div class="welcome-banner organizer">
    <div class="welcome-content">
        <h1>Welcome, {{ current_user.name }}! ðŸŽ¯</h1>
        <p>Manage your events and track performance</p>
    </div>
    <a href="{{ url_for('organizer.create_event') }}" class="btn btn-primary">
        <i class="fas fa-plus-circle"></i> Create Event
    </a>
</div>

<!-- Dashboard Stats -->
<div class="dashboard-stats">
    <div class="stat-card">
        <div class="stat-icon blue">
            <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="stat-info">
            <span class="stat-label">My Events</span>
            <h3 class="stat-number">â‚¹{{ stats.total_revenue|round|int }}</h3>
            <span class="stat-trend positive">
                <i class="fas fa-arrow-up"></i> {{ stats.active_events }} active
            </span>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon purple">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-info">
            <span class="stat-label">Total Registrations</span>
            <h3 class="stat-number">{{ stats.total_registrations }}</h3>
            <span class="stat-trend positive">
                <i class="fas fa-arrow-up"></i> {{ stats.recent_registrations }} this week
            </span>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon green">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-info">
            <span class="stat-label">Attendance Rate</span>
            <h3 class="stat-number">{{ "%.1f"|format(stats.attendance_rate) }}%</h3>
            <span class="stat-trend">
                <i class="fas fa-check-circle"></i> Good engagement
            </span>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon orange">
            <i class="fas fa-rupee-sign"></i>
        </div>
        <div class="stat-info">
            <span class="stat-label">Revenue</span>
            <h3 class="stat-number">â‚¹{{ stats.total_revenue|round|int }}</h3>
            <span class="stat-trend positive">
                <i class="fas fa-arrow-up"></i> From paid events
            </span>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-grid">
    <div class="chart-card">
        <div class="chart-header">
            <h3>Registration Trends</h3>
        </div>
        <div class="chart-body">
            <canvas id="registrationChart"></canvas>
        </div>
    </div>
    
    <div class="chart-card">
        <div class="chart-header">
            <h3>Event Categories</h3>
        </div>
        <div class="chart-body">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
</div>

<!-- My Events -->
<div class="section-card">
    <div class="section-header">
        <h3><i class="fas fa-calendar-check"></i> My Events</h3>
        <a href="{{ url_for('organizer.my_events') }}" class="view-all-link">
            View all <i class="fas fa-arrow-right"></i>
        </a>
    </div>
    
    {% if my_events %}
    <div class="events-table-wrapper">
        <table class="events-table">
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Date</th>
                    <th>Registrations</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for event in my_events[:5] %}
                <tr>
                    <td>
                        <div class="event-info-table">
                            <div class="event-avatar-table">
    {% if event.image %}
        <img src="{{ url_for('static', filename='uploads/events/' + event.image) }}"
             alt="{{ event.title }}"
             style="width:40px;height:40px;object-fit:cover;border-radius:10px;">
    {% else %}
        {{ event.title[0] }}
    {% endif %}
</div>
                            <div>
                                <div class="event-title-table">{{ event.title }}</div>
                                <div class="event-category-table">{{ event.category|title }}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="date-info">
                            <strong>{{ event.event_date.strftime('%b %d, %Y') }}</strong>
                            <span>{{ event.event_date.strftime('%I:%M %p') }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="registration-info">
                            <strong>{{ event.registrations.count() }} / {{ event.max_participants }}</strong>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ (event.registrations.count() / event.max_participants * 100)|int }}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge badge-{{ 'success' if event.is_active else 'warning' }}">
                            {{ 'Active' if event.is_active else 'Pending' }}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="{{ url_for('organizer.event_details', event_id=event.id) }}" class="btn-icon" title="View Details">

                            </a>
                            <a href="{{ url_for('organizer.edit_event', event_id=event.id) }}" class="btn-icon" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{{ url_for('organizer.qr_scanner') }}" class="btn-icon" title="QR Scanner">
                                <i class="fas fa-qrcode"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-calendar-plus"></i>
        <h3>No events yet</h3>
        <p>Create your first event to start managing registrations</p>
        <a href="{{ url_for('organizer.create_event') }}" class="btn btn-primary">
            <i class="fas fa-plus-circle"></i> Create Event
        </a>
    </div>
    {% endif %}
</div>

<!-- Quick Actions -->
<div class="quick-actions">
    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
    <div class="actions-grid">
        <a href="{{ url_for('organizer.create_event') }}" class="action-card">
            <i class="fas fa-plus-circle"></i>
            <span>Create Event</span>
        </a>
        <a href="{{ url_for('organizer.my_events') }}" class="action-card">
            <i class="fas fa-calendar-alt"></i>
            <span>Manage Events</span>
        </a>
        <a href="{{ url_for('organizer.qr_scanner') }}" class="action-card">
            <i class="fas fa-qrcode"></i>
            <span>Scan QR</span>
        </a>
        <a href="{{ url_for('auth.profile') }}" class="action-card">
            <i class="fas fa-user-cog"></i>
            <span>Settings</span>
        </a>
    </div>
</div>

<style>
/* Hide hamburger on desktop */
@media (min-width: 769px) {
    .top-nav-left .sidebar-toggle {
        display: none !important;
    }
}

/* Welcome Banner - Organizer variant */
.welcome-banner.organizer {
    background: linear-gradient(135deg, #a855f7, #ec4899);
    border-radius: 16px;
    padding: 40px;
    margin-bottom: 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 8px 24px rgba(168, 85, 247, 0.25);
}

.welcome-content h1 {
    font-size: 32px;
    font-weight: 700;
    margin: 0 0 8px 0;
    color: white;
}

.welcome-content p {
    font-size: 16px;
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
}

/* Dashboard Stats */
.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--bg-elevated);
    border-radius: 12px;
    padding: 24px;
    display: flex;
    gap: 16px;
    align-items: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
}

.stat-icon.blue {
    background: rgba(77, 166, 255, 0.12);
    color: #4da6ff;
}

.stat-icon.purple {
    background: rgba(168, 85, 247, 0.12);
    color: #a855f7;
}

.stat-icon.green {
    background: rgba(16, 185, 129, 0.12);
    color: #10b981;
}

.stat-icon.orange {
    background: rgba(251, 146, 60, 0.12);
    color: #fb923c;
}

.stat-info {
    flex: 1;
}

.stat-label {
    display: block;
    font-size: 12px;
    color: var(--text-tertiary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.stat-number {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -1px;
    margin: 0 0 4px 0;
}

.stat-trend {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 500;
}

.stat-trend.positive {
    color: #10b981;
}

.stat-trend i {
    font-size: 11px;
    margin-right: 4px;
}

/* Charts Grid */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-card {
    background: var(--bg-elevated);
    border-radius: 12px;
    padding: 24px;
}

.chart-header h3 {
    font-size: 18px;
    font-weight: 700;
    margin: 0 0 20px 0;
}

.chart-body {
    height: 280px;
}

.chart-body canvas {
    max-height: 100%;
}

/* Section Card */
.section-card {
    background: var(--bg-elevated);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 30px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.section-header h3 {
    font-size: 20px;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-header h3 i {
    color: var(--accent);
}

.view-all-link {
    color: var(--accent);
    text-decoration: none;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: opacity 0.2s ease;
}

.view-all-link:hover {
    opacity: 0.8;
}

/* Events Table */
.events-table-wrapper {
    overflow-x: auto;
}

.events-table {
    width: 100%;
    border-collapse: collapse;
}

.events-table thead tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.events-table th {
    text-align: left;
    padding: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-tertiary);
}

.events-table td {
    padding: 16px 12px;
    font-size: 14px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.03);
}

.events-table tbody tr {
    transition: background 0.2s ease;
}

.events-table tbody tr:hover {
    background: var(--bg-elevated-2);
}

.event-info-table {
    display: flex;
    align-items: center;
    gap: 12px;
}

.event-avatar-table {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--accent), #a78bfa);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 16px;
    flex-shrink: 0;
}

.event-title-table {
    font-weight: 600;
    margin-bottom: 4px;
}

.event-category-table {
    font-size: 12px;
    color: var(--text-tertiary);
}

.date-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.date-info strong {
    font-weight: 600;
}

.date-info span {
    font-size: 12px;
    color: var(--text-tertiary);
}

.registration-info {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.registration-info strong {
    font-weight: 600;
}

.progress-bar {
    width: 120px;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #a78bfa);
    transition: width 0.3s ease;
}

.badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.badge-success {
    background: rgba(16, 185, 129, 0.12);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.badge-warning {
    background: rgba(251, 146, 60, 0.12);
    color: #fb923c;
    border: 1px solid rgba(251, 146, 60, 0.3);
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.btn-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-base);
    border-radius: 8px;
    color: var(--text-secondary);
    text-decoration: none;
    transition: all 0.2s ease;
}

.btn-icon:hover {
    background: var(--accent);
    color: white;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-state i {
    font-size: 64px;
    color: var(--text-tertiary);
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-state h3 {
    font-size: 20px;
    font-weight: 700;
    margin: 0 0 8px 0;
}

.empty-state p {
    color: var(--text-secondary);
    margin: 0 0 24px 0;
}

/* Quick Actions */
.quick-actions h3 {
    font-size: 20px;
    font-weight: 700;
    margin: 0 0 20px 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.quick-actions h3 i {
    color: var(--accent);
}

.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.action-card {
    background: var(--bg-elevated);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    text-decoration: none;
    transition: all 0.2s ease;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.action-card:hover {
    transform: translateY(-2px);
    border-color: var(--accent);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}

.action-card i {
    font-size: 32px;
    color: var(--accent);
    margin-bottom: 12px;
    display: block;
}

.action-card span {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
}

/* Responsive */
@media (max-width: 768px) {
    .welcome-banner.organizer {
        flex-direction: column;
        gap: 20px;
        text-align: center;
        padding: 30px 20px;
    }
    
    .welcome-content h1 {
        font-size: 24px;
    }
    
    .dashboard-stats {
        grid-template-columns: 1fr;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .actions-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .events-table-wrapper {
        overflow-x: scroll;
    }
}
</style>

<script>
(function() {
    'use strict';
    
    // Chart data from backend
    const chartData = {
        registrationLabels: {{ stats.registration_labels | tojson | safe }},
        registrationData: {{ stats.registration_data | tojson | safe }},
        categoryLabels: {{ stats.category_labels | tojson | safe }},
        categoryData: {{ stats.category_data | tojson | safe }}
    };
    
    // Registration Trends Chart
    const regCtx = document.getElementById('registrationChart');
    if (regCtx && chartData.registrationLabels.length > 0) {
        new Chart(regCtx, {
            type: 'line',
            data: {
                labels: chartData.registrationLabels,
                datasets: [{
                    label: 'Registrations',
                    data: chartData.registrationData,
                    borderColor: '#a855f7',
                    backgroundColor: 'rgba(168, 85, 247, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#a855f7',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: { color: '#9ca3af', font: { size: 11 } },
                        grid: { color: 'rgba(255, 255, 255, 0.05)', drawBorder: false },
                        border: { display: false }
                    },
                    x: {
                        ticks: { color: '#9ca3af', font: { size: 11 } },
                        grid: { display: false },
                        border: { display: false }
                    }
                }
            }
        });
    }
    
    // Category Chart
    const catCtx = document.getElementById('categoryChart');
    if (catCtx && chartData.categoryLabels.length > 0) {
        new Chart(catCtx, {
            type: 'doughnut',
            data: {
                labels: chartData.categoryLabels,
                datasets: [{
                    data: chartData.categoryData,
                    backgroundColor: ['#4da6ff', '#a855f7', '#10b981', '#fb923c', '#ef4444', '#06b6d4'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#9ca3af', padding: 15, font: { size: 12 } }
                    }
                },
                cutout: '65%'
            }
        });
    }
})();
</script>
{% endblock %}
