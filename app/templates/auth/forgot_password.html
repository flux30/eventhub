{% extends "base.html" %}

{% block title %}Reset Password - EventHub{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-ambient-blob"></div>
    
    <div class="auth-wrapper">
        <!-- Left side - Branding -->
        <div class="auth-brand-side">
            <div class="brand-content">
                <h1 class="brand-title">Reset Password</h1>
                <p class="brand-subtitle">We'll help you get back into your account</p>
                
                <div class="brand-features">
                    <div class="brand-feature">
                        <div class="feature-icon-premium">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L3 7V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V7L12 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <span>Secure verification process</span>
                    </div>
                    <div class="brand-feature">
                        <div class="feature-icon-premium">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M17 20.5H7C4 20.5 2 19 2 15.5V8.5C2 5 4 3.5 7 3.5H17C20 3.5 22 5 22 8.5V15.5C22 19 20 20.5 17 20.5Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M17 9L13.87 11.5C12.84 12.32 11.15 12.32 10.12 11.5L7 9" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <span>4-digit code sent to email</span>
                    </div>
                    <div class="brand-feature">
                        <div class="feature-icon-premium">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 8V13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <span>Takes less than 2 minutes</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right side - Form -->
        <div class="auth-form-side">
            <div class="auth-card" id="auth-card">
                <div class="auth-header">
                    <h2>Forgot Password?</h2>
                    <p>Enter your email to receive a reset code</p>
                </div>
                
                <!-- Email Form -->
                <form method="POST" class="auth-form" id="forgot-form">
                    <div class="form-group-auth">
                        <label for="email">Email address</label>
                        <input 
                            type="email" 
                            id="email" 
                            name="email" 
                            class="form-control-auth" 
                            placeholder="you@example.com"
                            autocomplete="email"
                            required
                            autofocus
                        >
                    </div>
                    
                    <button type="submit" class="btn-auth btn-primary-auth" id="submit-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                            <path d="M17 20.5H7C4 20.5 2 19 2 15.5V8.5C2 5 4 3.5 7 3.5H17C20 3.5 22 5 22 8.5V15.5C22 19 20 20.5 17 20.5Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M17 9L13.87 11.5C12.84 12.32 11.15 12.32 10.12 11.5L7 9" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Send Reset Code
                    </button>
                </form>
                
                <div class="auth-divider">
                    <span>or</span>
                </div>
                
                <p class="auth-footer-text">
                    Remember your password? <a href="{{ url_for('auth.login') }}" class="auth-link">Sign in</a>
                </p>
            </div>
        </div>
    </div>
</div>

<style>
/* Reuse all styles from register.html - same CSS */
.auth-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    padding: 40px 20px;
}

.auth-ambient-blob {
    position: absolute;
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, rgba(77, 166, 255, 0.12), transparent 70%);
    top: -200px;
    right: -150px;
    filter: blur(100px);
    animation: ambient-float 20s ease-in-out infinite;
}

@keyframes ambient-float {
    0%, 100% { transform: translate(0, 0); }
    50% { transform: translate(60px, -50px); }
}

.auth-wrapper {
    max-width: 1300px;
    width: 100%;
    display: grid;
    grid-template-columns: 5fr 7fr;
    gap: 80px;
    align-items: center;
    position: relative;
    z-index: 1;
}

.auth-brand-side {
    padding: 40px;
}

.brand-content {
    max-width: 480px;
}

.brand-title {
    font-size: 52px;
    font-weight: 800;
    letter-spacing: -2px;
    margin-bottom: 16px;
    line-height: 1.1;
}

.brand-subtitle {
    font-size: 18px;
    color: var(--text-secondary);
    margin-bottom: 56px;
    line-height: 1.6;
}

.brand-features {
    display: flex;
    flex-direction: column;
    gap: 24px;
    margin-bottom: 48px;
}

.brand-feature {
    display: flex;
    align-items: center;
    gap: 16px;
}

.feature-icon-premium {
    width: 48px;
    height: 48px;
    background: var(--bg-elevated);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--accent);
    flex-shrink: 0;
}

.feature-icon-premium svg {
    width: 24px;
    height: 24px;
}

.brand-feature span {
    font-size: 16px;
    font-weight: 500;
    color: var(--text-primary);
}

.auth-form-side {
    padding: 40px;
}

.auth-card {
    background: var(--bg-elevated);
    border-radius: 24px;
    padding: 56px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
    animation: slideInRight 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    max-width: 600px;
    width: 100%;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.auth-card.shake {
    animation: shake 0.3s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
}

@keyframes shake {
    10%, 90% { transform: translateX(-5px); }
    20%, 80% { transform: translateX(5px); }
    30%, 50%, 70% { transform: translateX(-3px); }
    40%, 60% { transform: translateX(3px); }
}

.auth-header {
    margin-bottom: 40px;
}

.auth-header h2 {
    font-size: 36px;
    font-weight: 700;
    letter-spacing: -1px;
    margin-bottom: 8px;
}

.auth-header p {
    color: var(--text-secondary);
    font-size: 15px;
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.form-group-auth {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group-auth label {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
}

.form-control-auth {
    width: 100%;
    padding: 16px 18px;
    background: var(--bg-base);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    font-size: 15px;
    font-family: inherit;
    color: var(--text-primary);
    transition: border 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
}

.form-control-auth:hover {
    border-color: rgba(255, 255, 255, 0.15);
}

.form-control-auth:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 4px rgba(77, 166, 255, 0.15);
    background: var(--bg-elevated);
}

.form-control-auth::placeholder {
    color: var(--text-tertiary);
}

.btn-auth {
    width: 100%;
    padding: 16px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.25s ease;
    border: none;
    font-family: inherit;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-primary-auth {
    background: var(--text-primary);
    color: var(--bg-base);
}

.btn-primary-auth:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.5);
}

.btn-primary-auth:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.auth-divider {
    position: relative;
    text-align: center;
    margin: 32px 0;
}

.auth-divider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: rgba(255, 255, 255, 0.08);
}

.auth-divider span {
    position: relative;
    background: var(--bg-elevated);
    padding: 0 16px;
    font-size: 13px;
    color: var(--text-tertiary);
}

.auth-footer-text {
    text-align: center;
    color: var(--text-secondary);
    font-size: 14px;
}

.auth-link {
    color: var(--accent);
    text-decoration: none;
    font-weight: 600;
    transition: opacity 0.25s ease;
}

.auth-link:hover {
    opacity: 0.8;
}

/* OTP Styles */
.otp-verification-section {
    animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.otp-header {
    text-align: center;
    margin-bottom: 32px;
}

.otp-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    background: var(--bg-base);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--accent);
}

.otp-icon svg {
    width: 48px;
    height: 48px;
}

.otp-header h3 {
    font-size: 24px;
    font-weight: 700;
    margin: 0 0 8px 0;
}

.otp-header p {
    color: var(--text-secondary);
    font-size: 14px;
    margin: 0 0 4px 0;
}

.otp-header strong {
    color: var(--accent);
    font-size: 16px;
}

.otp-form {
    margin-bottom: 24px;
}

.otp-inputs {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-bottom: 28px;
}

.otp-box {
    width: 64px !important;
    height: 64px !important;
    text-align: center;
    font-size: 28px;
    font-weight: 700;
    border: 2px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 12px !important;
    background: var(--bg-base) !important;
    color: var(--text-primary) !important;
    transition: all 0.2s ease !important;
    padding: 0 !important;
}

.otp-box:focus {
    border-color: var(--accent) !important;
    box-shadow: 0 0 0 4px rgba(77, 166, 255, 0.15) !important;
    transform: scale(1.05);
    background: var(--bg-elevated) !important;
}

.password-wrapper {
    position: relative;
}

.password-wrapper .form-control-auth {
    padding-right: 50px;
}

.password-toggle-auth {
    position: absolute;
    right: 0;
    top: 0;
    height: 100%;
    width: 50px;
    background: transparent;
    border: none;
    color: var(--text-tertiary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.25s ease;
}

.password-toggle-auth:hover {
    color: var(--accent);
}

.field-hint {
    font-size: 12px;
    color: var(--text-tertiary);
}

.field-hint.error {
    color: #ef4444;
}

.field-hint.success {
    color: #10b981;
}

.resend-section {
    text-align: center;
    padding-top: 24px;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.resend-section p {
    color: var(--text-secondary);
    font-size: 14px;
    margin: 0 0 12px 0;
}

.resend-section .auth-link {
    display: inline-flex;
    align-items: center;
    background: none;
    border: none;
    cursor: pointer;
}

.resend-section .auth-link:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@media (max-width: 968px) {
    .auth-wrapper {
        grid-template-columns: 1fr;
        gap: 40px;
    }
    
    .auth-brand-side {
        display: none;
    }
    
    .auth-card {
        padding: 40px;
        max-width: 100%;
    }
}

@media (max-width: 576px) {
    .auth-card {
        padding: 32px 24px;
    }
    
    .brand-title {
        font-size: 36px;
    }
    
    .auth-header h2 {
        font-size: 28px;
    }
    
    .otp-box {
        width: 54px !important;
        height: 54px !important;
        font-size: 24px;
    }
    
    .otp-inputs {
        gap: 8px;
    }
}
</style>

<script>
{% raw %}
// Toggle password visibility
function togglePasswordAuth(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '-icon');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.innerHTML = '<path d="M14.53 9.47004L9.47004 14.53C8.82004 13.88 8.42004 12.99 8.42004 12C8.42004 10.02 10.02 8.42004 12 8.42004C12.99 8.42004 13.88 8.82004 14.53 9.47004Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M17.82 5.76998C16.07 4.44998 14.07 3.72998 12 3.72998C8.46997 3.72998 5.17997 5.80998 2.88997 9.40998C1.98997 10.82 1.98997 13.19 2.88997 14.6C3.67997 15.84 4.59997 16.91 5.59997 17.77" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.42004 19.5301C9.56004 20.0101 10.77 20.2701 12 20.2701C15.53 20.2701 18.82 18.1901 21.11 14.5901C22.01 13.1801 22.01 10.8101 21.11 9.40005C20.78 8.88005 20.42 8.39005 20.05 7.93005" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M15.5099 12.7C15.2499 14.11 14.0999 15.26 12.6899 15.52" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M9.47 14.53L2 22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 2L14.53 9.47" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>';
    } else {
        field.type = 'password';
        icon.innerHTML = '<path d="M15.58 12C15.58 13.98 13.98 15.58 12 15.58C10.02 15.58 8.42004 13.98 8.42004 12C8.42004 10.02 10.02 8.42004 12 8.42004C13.98 8.42004 15.58 10.02 15.58 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 20.27C15.53 20.27 18.82 18.19 21.11 14.59C22.01 13.18 22.01 10.81 21.11 9.39997C18.82 5.79997 15.53 3.71997 12 3.71997C8.46997 3.71997 5.17997 5.79997 2.88997 9.39997C1.98997 10.81 1.98997 13.18 2.88997 14.59C5.17997 18.19 8.46997 20.27 12 20.27Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>';
    }
}

// Loading state on submit
const forgotForm = document.getElementById('forgot-form');
const submitBtn = document.getElementById('submit-btn');

if (forgotForm) {
    forgotForm.addEventListener('submit', function(e) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<svg width="20" height="20" class="spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity="0.2"/><path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" stroke-linecap="round"/></svg> Sending...';
    });
}

// Resend OTP function
function resendOTP() {
    const btn = document.getElementById('resend-btn');
    btn.disabled = true;
    btn.innerHTML = '<svg width="16" height="16" class="spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity="0.2"/><path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" stroke-linecap="round"/></svg> Sending...';
{% endraw %}

    fetch('{{ url_for("auth.resend_password_otp") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            alert(data.message);
            startCountdown(60);
        } else {
            alert(data.message);
            document.getElementById('resend-btn').disabled = false;
            document.getElementById('resend-btn').innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;"><path d="M22 12C22 17.52 17.52 22 12 22C6.48 22 3.11 16.44 3.11 16.44M3.11 16.44H7.63M3.11 16.44V21.44M2 12C2 6.48 6.44 2 12 2C18.67 2 22 7.56 22 7.56M22 7.56V2.56M22 7.56H17.56" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg> Resend OTP';
        }
    })
    .catch(function(error) {
        alert('‚ùå Failed to resend OTP');
        document.getElementById('resend-btn').disabled = false;
        document.getElementById('resend-btn').innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;"><path d="M22 12C22 17.52 17.52 22 12 22C6.48 22 3.11 16.44 3.11 16.44M3.11 16.44H7.63M3.11 16.44V21.44M2 12C2 6.48 6.44 2 12 2C18.67 2 22 7.56 22 7.56M22 7.56V2.56M22 7.56H17.56" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg> Resend OTP';
    });
}

{% raw %}
function startCountdown(seconds) {
    const btn = document.getElementById('resend-btn');
    if (!btn) return;
    
    let remaining = seconds;
    
    const timer = setInterval(function() {
        remaining--;
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;"><path d="M22 12C22 17.52 17.52 22 12 22C6.48 22 2 6.48 2 12C2 17.52 6.48 22 12 22Z" stroke="currentColor" stroke-width="1.5"/><path d="M15.71 15.18L12.61 13.33C12.07 13.01 11.63 12.24 11.63 11.61V7.51001" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg> Resend in ' + remaining + 's';
        
        if (remaining <= 0) {
            clearInterval(timer);
            btn.disabled = false;
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;"><path d="M22 12C22 17.52 17.52 22 12 22C6.48 22 3.11 16.44 3.11 16.44M3.11 16.44H7.63M3.11 16.44V21.44M2 12C2 6.48 6.44 2 12 2C18.67 2 22 7.56 22 7.56M22 7.56V2.56M22 7.56H17.56" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg> Resend OTP';
        }
    }, 1000);
}
{% endraw %}
</script>

{% if show_otp %}
<script>
// OTP & Password Reset Functionality
(function() {
    // Hide email form
    document.getElementById('forgot-form').style.display = 'none';

    // Create OTP + New Password section
    const resetSection = document.createElement('div');
    resetSection.className = 'otp-verification-section';
    resetSection.innerHTML = `
        <div class="otp-header">
            <div class="otp-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L3 7V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V7L12 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <h3>Verify & Reset Password</h3>
            <p>We've sent a 4-digit code to</p>
            <strong>{{ email }}</strong>
        </div>

        <form method="POST" id="reset-form" class="otp-form">
            <label style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; display: block;">Enter OTP Code</label>
            <div class="otp-inputs">
                <input type="text" maxlength="1" name="otp1" id="otp1" class="otp-box" autofocus required pattern="[0-9]">
                <input type="text" maxlength="1" name="otp2" id="otp2" class="otp-box" required pattern="[0-9]">
                <input type="text" maxlength="1" name="otp3" id="otp3" class="otp-box" required pattern="[0-9]">
                <input type="text" maxlength="1" name="otp4" id="otp4" class="otp-box" required pattern="[0-9]">
            </div>

            <div class="form-group-auth" style="margin-bottom: 16px;">
                <label for="new_password">New Password</label>
                <div class="password-wrapper">
                    <input 
                        type="password" 
                        id="new_password" 
                        name="new_password" 
                        class="form-control-auth" 
                        placeholder="Minimum 8 characters"
                        required
                        minlength="8"
                    >
                    <button type="button" class="password-toggle-auth" onclick="togglePasswordAuth('new_password')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" id="new_password-icon">
                            <path d="M15.58 12C15.58 13.98 13.98 15.58 12 15.58C10.02 15.58 8.42004 13.98 8.42004 12C8.42004 10.02 10.02 8.42004 12 8.42004C13.98 8.42004 15.58 10.02 15.58 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 20.27C15.53 20.27 18.82 18.19 21.11 14.59C22.01 13.18 22.01 10.81 21.11 9.39997C18.82 5.79997 15.53 3.71997 12 3.71997C8.46997 3.71997 5.17997 5.79997 2.88997 9.39997C1.98997 10.81 1.98997 13.18 2.88997 14.59C5.17997 18.19 8.46997 20.27 12 20.27Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="form-group-auth" style="margin-bottom: 24px;">
                <label for="confirm_password">Confirm New Password</label>
                <div class="password-wrapper">
                    <input 
                        type="password" 
                        id="confirm_password" 
                        name="confirm_password" 
                        class="form-control-auth" 
                        placeholder="Re-enter your password"
                        required
                        minlength="8"
                    >
                    <button type="button" class="password-toggle-auth" onclick="togglePasswordAuth('confirm_password')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" id="confirm_password-icon">
                            <path d="M15.58 12C15.58 13.98 13.98 15.58 12 15.58C10.02 15.58 8.42004 13.98 8.42004 12C8.42004 10.02 10.02 8.42004 12 8.42004C13.98 8.42004 15.58 10.02 15.58 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 20.27C15.53 20.27 18.82 18.19 21.11 14.59C22.01 13.18 22.01 10.81 21.11 9.39997C18.82 5.79997 15.53 3.71997 12 3.71997C8.46997 3.71997 5.17997 5.79997 2.88997 9.39997C1.98997 10.81 1.98997 13.18 2.88997 14.59C5.17997 18.19 8.46997 20.27 12 20.27Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                <span class="field-hint" id="confirm-hint"></span>
            </div>

            <button type="submit" class="btn-auth btn-primary-auth">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                    <path d="M12 2L3 7V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V7L12 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Reset Password
            </button>
        </form>

        <div class="resend-section">
            <p>Didn't receive the code?</p>
            <button type="button" id="resend-btn" class="auth-link" onclick="resendOTP()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                    <path d="M22 12C22 17.52 17.52 22 12 22C6.48 22 3.11 16.44 3.11 16.44M3.11 16.44H7.63M3.11 16.44V21.44M2 12C2 6.48 6.44 2 12 2C18.67 2 22 7.56 22 7.56M22 7.56V2.56M22 7.56H17.56" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Resend OTP
            </button>
        </div>
    `;

    const authHeader = document.querySelector('.auth-header');
    authHeader.after(resetSection);

    // OTP Auto-move functionality
    const otpInputs = document.querySelectorAll('.otp-box');

    otpInputs.forEach(function(input, index) {
        input.addEventListener('input', function(e) {
            if (this.value.length === 1 && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value === '' && index > 0) {
                otpInputs[index - 1].focus();
            }
        });

        input.addEventListener('keypress', function(e) {
            if (!/[0-9]/.test(e.key)) {
                e.preventDefault();
            }
        });

        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 4);
            
            pastedData.split('').forEach(function(char, i) {
                if (otpInputs[i]) {
                    otpInputs[i].value = char;
                }
            });
            
            if (pastedData.length === 4) {
                otpInputs[3].focus();
            }
        });
    });

    // Password confirmation validation
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    const confirmHint = document.getElementById('confirm-hint');
    let confirmTimer = null;

    if (confirmPassword && newPassword) {
        confirmPassword.addEventListener('input', function() {
            clearTimeout(confirmTimer);
            
            if (confirmPassword.value === '') {
                confirmPassword.setCustomValidity('');
                confirmHint.textContent = '';
                confirmHint.className = 'field-hint';
                return;
            }
            
            confirmTimer = setTimeout(function() {
                if (confirmPassword.value !== newPassword.value) {
                    confirmPassword.setCustomValidity('Passwords do not match');
                    confirmHint.textContent = 'Passwords do not match';
                    confirmHint.className = 'field-hint error';
                } else {
                    confirmPassword.setCustomValidity('');
                    confirmHint.textContent = 'Passwords match!';
                    confirmHint.className = 'field-hint success';
                }
            }, 500);
        });
    }

    // Form validation
    const resetForm = document.getElementById('reset-form');
    if (resetForm) {
        resetForm.addEventListener('submit', function(e) {
            if (confirmPassword.value !== newPassword.value) {
                e.preventDefault();
                confirmPassword.setCustomValidity('Passwords do not match');
                confirmPassword.reportValidity();
                return;
            }
        });
    }

    otpInputs[0].focus();
    startCountdown(60);
})();
</script>
{% endif %}
{% endblock %}
