{% extends "base.html" %}

{% block title %}Manage Events - EventHub{% endblock %}
{% block page_title %}Manage Events{% endblock %}

{% block content %}

<!-- Stats -->
<div class="dashboard-stats">
    <div class="stat-card">
        <div class="stat-icon blue"><i class="fas fa-calendar-alt"></i></div>
        <div class="stat-info">
            <span class="stat-label">Total Events</span>
            <h3 class="stat-number">{{ events|length }}</h3>
            <span class="stat-trend">All time</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green"><i class="fas fa-calendar-check"></i></div>
        <div class="stat-info">
            <span class="stat-label">Active</span>
            <h3 class="stat-number">{{ events|selectattr('is_active')|list|length }}</h3>
            <span class="stat-trend">Live events</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon red"><i class="fas fa-calendar-times"></i></div>
        <div class="stat-info">
            <span class="stat-label">Inactive</span>
            <h3 class="stat-number">{{ events|rejectattr('is_active')|list|length }}</h3>
            <span class="stat-trend">Disabled events</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon orange"><i class="fas fa-ticket-alt"></i></div>
        <div class="stat-info">
            <span class="stat-label">Paid Events</span>
            <h3 class="stat-number">{{ events|selectattr('is_paid')|list|length }}</h3>
            <span class="stat-trend">Ticketed</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon purple"><i class="fas fa-gift"></i></div>
        <div class="stat-info">
            <span class="stat-label">Free Events</span>
            <h3 class="stat-number">{{ events|rejectattr('is_paid')|list|length }}</h3>
            <span class="stat-trend">Open access</span>
        </div>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-search">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search by title or organizer…">
    </div>
    <select id="statusFilter" class="filter-select">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
    </select>
    <select id="paidFilter" class="filter-select">
        <option value="">All Types</option>
        <option value="paid">Paid</option>
        <option value="free">Free</option>
    </select>
    <span class="filter-count" id="rowCount"></span>
</div>

<!-- Table -->
<div class="data-card">
    <div class="data-card-header">
        <h3>All Events</h3>
    </div>
    <div class="data-table-wrapper">
        <table class="data-table" id="eventsTable">
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Organizer</th>
                    <th>Date</th>
                    <th>Seats</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for event in events %}
                <tr id="event-row-{{ event.id }}"
                    data-title="{{ event.title }}"
                    data-organizer="{{ event.organizer.name if event.organizer else '' }}"
                    data-status="{{ 'active' if event.is_active else 'inactive' }}"
                    data-paid="{{ 'paid' if event.is_paid else 'free' }}">
                    <td>
                        <div class="entity-info">
                            <div class="entity-avatar event-avatar">{{ event.title[0]|upper }}</div>
                            <div>
                                <div class="entity-name">{{ event.title }}</div>
                                <div class="cell-muted" style="font-size:12px;">{{ event.category or '—' }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="cell-muted">{{ event.organizer.name if event.organizer else '—' }}</td>
                    <td class="cell-muted">{{ event.event_date.strftime('%d %b %Y') if event.event_date else '—' }}</td>
                    <td>
                        <span class="{{ 'seats-full' if event.available_seats == 0 else 'seats-ok' }}">
                            {{ event.available_seats }}/{{ event.max_participants }}
                        </span>
                        {% if event.available_seats == 0 %}
                        <span class="badge badge-danger" style="margin-left:6px;">Sold Out</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if event.is_paid %}
                        <span class="badge badge-warning">₹{{ event.price }}</span>
                        {% else %}
                        <span class="badge badge-success">Free</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge badge-{{ 'success' if event.is_active else 'secondary' }}"
                              id="event-status-badge-{{ event.id }}">
                            {{ 'Active' if event.is_active else 'Inactive' }}
                        </span>
                    </td>
                    <td class="cell-muted">{{ event.created_at.strftime('%d %b %Y') }}</td>
                    <td>
                        <div class="row-actions">
                            <button class="action-btn view-event-btn"
                                    data-event-id="{{ event.id }}" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn toggle-event-btn"
                                    data-event-id="{{ event.id }}"
                                    data-is-active="{{ 'true' if event.is_active else 'false' }}"
                                    title="{{ 'Deactivate' if event.is_active else 'Activate' }}">
                                <i class="fas fa-{{ 'ban' if event.is_active else 'check-circle' }}"></i>
                            </button>
                            <button class="action-btn action-danger delete-event-btn"
                                    data-event-id="{{ event.id }}"
                                    data-event-title="{{ event.title }}" title="Delete Event">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="8" class="no-data">No events found</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal-backdrop" id="deleteModal">
    <div class="modal-box modal-box-sm">
        <div class="modal-box-header">
            <h3>Delete Event</h3>
            <button class="modal-box-close" onclick="closeModal('deleteModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-box-body">
            <div class="confirm-body">
                <div class="confirm-icon red-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <p>Delete <strong id="deleteEventTitle"></strong>?</p>
                <p class="confirm-sub">All registrations for this event will also be deleted. This cannot be undone.</p>
            </div>
            <input type="hidden" id="deleteEventId">
        </div>
        <div class="modal-box-footer">
            <button onclick="closeModal('deleteModal')" class="btn-ghost">Cancel</button>
            <button onclick="confirmDelete()" class="btn-danger-sm" id="deleteSubmitBtn">
                <span class="btn-text"><i class="fas fa-trash"></i> Delete Event</span>
                <span class="btn-spin hidden"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
        </div>
    </div>
</div>

<div id="toastContainer" class="toast-wrap"></div>

<style>
/* ── Stats ────────────────────────────────────────────────── */
.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px; margin-bottom: 28px;
}
.stat-card {
    background: var(--bg-elevated); border-radius: 12px; padding: 22px;
    display: flex; gap: 16px; align-items: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
.stat-icon {
    width: 52px; height: 52px; border-radius: 12px; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center; font-size: 22px;
}
.stat-icon.blue   { background: rgba(77,166,255,0.12);  color: #4da6ff; }
.stat-icon.purple { background: rgba(168,85,247,0.12);  color: #a855f7; }
.stat-icon.green  { background: rgba(16,185,129,0.12);  color: #10b981; }
.stat-icon.orange { background: rgba(251,146,60,0.12);  color: #fb923c; }
.stat-icon.red    { background: rgba(239,68,68,0.12);   color: #ef4444; }
.stat-info { flex: 1; min-width: 0; }
.stat-label  { display: block; font-size: 11px; color: var(--text-tertiary); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.stat-number { font-size: 26px; font-weight: 800; letter-spacing: -1px; margin: 0 0 4px; }
.stat-trend  { font-size: 12px; color: #9ca3af; }

/* ── Filter bar ────────────────────────────────────────────── */
.filter-bar {
    display: flex; gap: 12px; margin-bottom: 20px;
    flex-wrap: wrap; align-items: center;
}
.filter-search {
    flex: 1; min-width: 220px; position: relative;
    display: flex; align-items: center;
}
.filter-search i { position: absolute; left: 14px; color: #9ca3af; font-size: 13px; pointer-events: none; }
.filter-search input {
    width: 100%; padding: 10px 14px 10px 38px;
    background: var(--bg-elevated);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px; color: inherit; font-size: 14px;
    outline: none; transition: border-color 0.2s;
}
.filter-search input:focus { border-color: #4da6ff; }
.filter-select {
    padding: 10px 14px; min-width: 150px;
    background: var(--bg-elevated);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px; color: inherit; font-size: 14px;
    outline: none; cursor: pointer; transition: border-color 0.2s;
}
.filter-select:focus { border-color: #4da6ff; }
.filter-count { font-size: 12px; color: #9ca3af; white-space: nowrap; }

/* ── Data card ─────────────────────────────────────────────── */
.data-card { background: var(--bg-elevated); border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
.data-card-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 20px 24px; border-bottom: 1px solid rgba(255,255,255,0.05);
}
.data-card-header h3 { font-size: 17px; font-weight: 700; margin: 0; }
.data-table-wrapper { overflow-x: auto; }
.data-table { width: 100%; border-collapse: collapse; }
.data-table thead tr { border-bottom: 1px solid rgba(255,255,255,0.05); }
.data-table th {
    text-align: left; padding: 12px 16px;
    font-size: 11px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--text-tertiary); white-space: nowrap;
}
.data-table td {
    padding: 14px 16px; font-size: 14px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    vertical-align: middle;
}
.data-table tbody tr { transition: background 0.2s; }
.data-table tbody tr:hover { background: var(--bg-elevated-2); }
.data-table tbody tr:last-child td { border-bottom: none; }
.no-data { text-align: center; padding: 48px 20px !important; color: #9ca3af; font-size: 14px; }
.cell-muted { color: #9ca3af; font-size: 13px; }

/* ── Entity cell ───────────────────────────────────────────── */
.entity-info { display: flex; align-items: center; gap: 12px; }
.entity-avatar {
    width: 36px; height: 36px; flex-shrink: 0; border-radius: 8px;
    background: linear-gradient(135deg, #4da6ff, #a855f7);
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 14px; color: #fff;
}
.event-avatar { background: linear-gradient(135deg, #10b981, #4da6ff); }
.entity-name { font-weight: 500; font-size: 14px; }

/* ── Seats display ─────────────────────────────────────────── */
.seats-ok   { font-size: 13px; color: #9ca3af; }
.seats-full { font-size: 13px; color: #ef4444; font-weight: 600; }

/* ── Row actions ───────────────────────────────────────────── */
.row-actions { display: flex; gap: 6px; align-items: center; }
.action-btn {
    width: 32px; height: 32px; flex-shrink: 0;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 8px; color: #9ca3af; cursor: pointer;
    font-size: 13px; display: flex; align-items: center; justify-content: center;
    transition: background 0.2s, color 0.2s, border-color 0.2s;
}
.action-btn:hover { background: rgba(77,166,255,0.15); color: #4da6ff; border-color: rgba(77,166,255,0.3); }
.action-btn.action-danger:hover { background: rgba(239,68,68,0.15); color: #ef4444; border-color: rgba(239,68,68,0.3); }

/* ── Badges ────────────────────────────────────────────────── */
.badge {
    display: inline-block; padding: 3px 10px; border-radius: 20px;
    font-size: 11px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.3px; white-space: nowrap;
}
.badge-success  { background: rgba(16,185,129,0.12); color: #10b981; border: 1px solid rgba(16,185,129,0.25); }
.badge-warning  { background: rgba(251,146,60,0.12);  color: #fb923c; border: 1px solid rgba(251,146,60,0.25); }
.badge-danger   { background: rgba(239,68,68,0.12);   color: #ef4444; border: 1px solid rgba(239,68,68,0.25); }
.badge-secondary{ background: rgba(156,163,175,0.1);  color: #9ca3af; border: 1px solid rgba(156,163,175,0.2); }

/* ── Modal ─────────────────────────────────────────────────── */
.modal-backdrop {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.72); z-index: 1000;
    align-items: center; justify-content: center; padding: 20px;
}
.modal-backdrop.show { display: flex; }
.modal-box {
    background: var(--bg-elevated); border-radius: 16px;
    width: 100%; max-width: 440px; overflow: hidden;
    box-shadow: 0 24px 64px rgba(0,0,0,0.5);
    animation: modalIn 0.25s ease;
}
.modal-box-sm { max-width: 380px; }
@keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(-12px); } to { opacity: 1; transform: scale(1) translateY(0); } }
.modal-box-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 20px 24px; border-bottom: 1px solid rgba(255,255,255,0.06);
}
.modal-box-header h3 { margin: 0; font-size: 17px; font-weight: 700; }
.modal-box-close {
    width: 30px; height: 30px; background: rgba(255,255,255,0.06);
    border: none; border-radius: 8px; color: #9ca3af; cursor: pointer;
    font-size: 13px; display: flex; align-items: center; justify-content: center;
    transition: background 0.2s, color 0.2s;
}
.modal-box-close:hover { background: rgba(255,255,255,0.12); color: #fff; }
.modal-box-body { padding: 24px; }
.modal-box-footer {
    display: flex; gap: 10px; justify-content: flex-end;
    padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.06);
}

/* Confirm dialog */
.confirm-body { text-align: center; padding: 8px 0; }
.confirm-icon {
    width: 56px; height: 56px; margin: 0 auto 16px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; font-size: 22px;
}
.red-icon { background: rgba(239,68,68,0.12); color: #ef4444; }
.confirm-body p { margin: 0 0 8px; font-size: 15px; font-weight: 500; }
.confirm-sub { font-size: 13px; color: #9ca3af; }

/* Buttons */
.btn-ghost {
    padding: 9px 18px; background: transparent;
    border: 1px solid rgba(255,255,255,0.1); border-radius: 10px;
    color: #9ca3af; font-size: 14px; font-weight: 600; cursor: pointer;
    transition: background 0.2s, color 0.2s;
}
.btn-ghost:hover { background: rgba(255,255,255,0.07); color: #fff; }
.btn-danger-sm {
    padding: 9px 20px; background: #ef4444; border: none;
    border-radius: 10px; color: #fff;
    font-size: 14px; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; gap: 6px; transition: background 0.2s;
}
.btn-danger-sm:hover    { background: #dc2626; }
.btn-danger-sm:disabled { opacity: 0.6; cursor: not-allowed; }

/* ── Toast ─────────────────────────────────────────────────── */
.toast-wrap {
    position: fixed; bottom: 24px; right: 24px;
    display: flex; flex-direction: column; gap: 10px; z-index: 9999;
}
.toast {
    min-width: 280px; max-width: 360px; padding: 14px 16px;
    background: var(--bg-elevated); border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px; display: flex; align-items: center; gap: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4); animation: toastIn 0.3s ease;
}
.toast-success { border-left: 3px solid #10b981; }
.toast-error   { border-left: 3px solid #ef4444; }
.toast-info    { border-left: 3px solid #4da6ff; }
.toast-icon { font-size: 16px; flex-shrink: 0; }
.toast-success .toast-icon { color: #10b981; }
.toast-error   .toast-icon { color: #ef4444; }
.toast-info    .toast-icon { color: #4da6ff; }
.toast-msg   { font-size: 13px; flex: 1; font-weight: 500; }
.toast-close { background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 12px; padding: 0; }
@keyframes toastIn  { from { transform: translateX(110%); opacity: 0; } to { transform: translateX(0);    opacity: 1; } }
@keyframes toastOut { from { transform: translateX(0);    opacity: 1; } to { transform: translateX(110%); opacity: 0; } }

.hidden { display: none !important; }

/* ── Responsive ────────────────────────────────────────────── */
@media (max-width: 900px) { .dashboard-stats { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 600px) {
    .dashboard-stats { grid-template-columns: 1fr; }
    .filter-bar { flex-direction: column; }
    .filter-search, .filter-select { width: 100%; min-width: unset; }
}
</style>

<script>
const TOTAL_EVENTS = {{ events|length }};

function showToast(msg, type) {
    type = type || 'info';
    var icons = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' };
    var t = document.createElement('div');
    t.className = 'toast toast-' + type;
    t.innerHTML = '<i class="fas ' + icons[type] + ' toast-icon"></i>' +
                  '<span class="toast-msg">' + msg + '</span>' +
                  '<button class="toast-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>';
    document.getElementById('toastContainer').appendChild(t);
    setTimeout(function() {
        t.style.animation = 'toastOut 0.3s ease forwards';
        setTimeout(function() { if (t.parentNode) t.remove(); }, 300);
    }, 4000);
}

function openModal(id)  { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

function setLoading(btnId, state) {
    var btn = document.getElementById(btnId);
    btn.querySelector('.btn-text').classList.toggle('hidden', state);
    btn.querySelector('.btn-spin').classList.toggle('hidden', !state);
    btn.disabled = state;
}

function updateRowCount() {
    var visible = Array.from(document.querySelectorAll('#eventsTable tbody tr'))
        .filter(function(r) { return r.style.display !== 'none' && !r.querySelector('.no-data'); }).length;
    document.getElementById('rowCount').textContent =
        'Showing ' + visible + ' of ' + TOTAL_EVENTS + ' event' + (TOTAL_EVENTS !== 1 ? 's' : '');
}

function filterTable() {
    var s  = document.getElementById('searchInput').value.toLowerCase();
    var st = document.getElementById('statusFilter').value;
    var p  = document.getElementById('paidFilter').value;
    document.querySelectorAll('#eventsTable tbody tr').forEach(function(row) {
        if (row.querySelector('.no-data')) return;
        var ok = (row.dataset.title.toLowerCase().includes(s) || row.dataset.organizer.toLowerCase().includes(s)) &&
                 (!st || row.dataset.status === st) &&
                 (!p  || row.dataset.paid   === p);
        row.style.display = ok ? '' : 'none';
    });
    updateRowCount();
}
document.getElementById('searchInput').addEventListener('keyup', filterTable);
document.getElementById('statusFilter').addEventListener('change', filterTable);
document.getElementById('paidFilter').addEventListener('change', filterTable);
updateRowCount();

document.addEventListener('click', function(e) {
    var v = e.target.closest('.view-event-btn');
    var t = e.target.closest('.toggle-event-btn');
    var d = e.target.closest('.delete-event-btn');
    if (v) window.location.href = '/admin/event-details/' + v.dataset.eventId;
    if (t) toggleEvent(t);
    if (d) openDeleteModal(d.dataset.eventId, d.dataset.eventTitle);
});

function toggleEvent(btn) {
    var eventId  = btn.dataset.eventId;
    var isActive = btn.dataset.isActive === 'true';
    fetch('/admin/toggle-event/' + eventId, { method: 'POST' })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            var na    = data.is_active;
            var row   = document.getElementById('event-row-' + eventId);
            var badge = document.getElementById('event-status-badge-' + eventId);
            var icon  = btn.querySelector('i');
            badge.textContent    = na ? 'Active' : 'Inactive';
            badge.className      = 'badge badge-' + (na ? 'success' : 'secondary');
            icon.className       = 'fas fa-' + (na ? 'ban' : 'check-circle');
            btn.title            = na ? 'Deactivate' : 'Activate';
            btn.dataset.isActive = String(na);
            row.dataset.status   = na ? 'active' : 'inactive';
            showToast('Event ' + (na ? 'activated' : 'deactivated') + '.', 'success');
        } else { showToast('Failed: ' + (data.error || 'Unknown error'), 'error'); }
    })
    .catch(function() { showToast('Network error.', 'error'); });
}

function openDeleteModal(eventId, eventTitle) {
    document.getElementById('deleteEventId').value          = eventId;
    document.getElementById('deleteEventTitle').textContent = eventTitle;
    openModal('deleteModal');
}
function confirmDelete() {
    var eventId = document.getElementById('deleteEventId').value;
    setLoading('deleteSubmitBtn', true);
    fetch('/admin/delete-event/' + eventId, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        setLoading('deleteSubmitBtn', false);
        if (data.success) {
            closeModal('deleteModal');
            showToast('Event deleted.', 'success');
            var row = document.getElementById('event-row-' + eventId);
            if (row) row.remove();
            updateRowCount();
        } else { showToast('Failed: ' + data.error, 'error'); }
    })
    .catch(function() { setLoading('deleteSubmitBtn', false); showToast('Network error.', 'error'); });
}

document.querySelectorAll('.modal-backdrop').forEach(function(el) {
    el.addEventListener('click', function(e) { if (e.target === el) el.classList.remove('show'); });
});
</script>
{% endblock %}
