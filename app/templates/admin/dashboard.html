{% extends "base.html" %}

{% block title %}Admin Dashboard - EventHub{% endblock %}
{% block page_title %}Admin Dashboard{% endblock %}

{% block content %}
<!-- Dashboard Stats -->
<div class="dashboard-stats">
    <div class="stat-card">
        <div class="stat-icon blue">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-info">
            <span class="stat-label">Total Users</span>
            <h3 class="stat-number">{{ stats.total_users }}</h3>
            <span class="stat-trend positive">
                <i class="fas fa-arrow-up"></i> {{ stats.new_users_today }} today
            </span>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon purple">
            <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="stat-info">
            <span class="stat-label">Active Events</span>
            <h3 class="stat-number">{{ stats.active_events }}</h3>
            <span class="stat-trend positive">
                <i class="fas fa-arrow-up"></i> {{ stats.total_events }} total
            </span>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon green">
            <i class="fas fa-ticket-alt"></i>
        </div>
        <div class="stat-info">
            <span class="stat-label">Total Bookings</span>
            <h3 class="stat-number">{{ stats.total_registrations }}</h3>
            <span class="stat-trend positive">
                <i class="fas fa-arrow-up"></i> {{ stats.registrations_today }} today
            </span>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon orange">
            <i class="fas fa-rupee-sign"></i>
        </div>
        <div class="stat-info">
            <span class="stat-label">Revenue</span>
            <h3 class="stat-number">â‚¹{{ "%.2f"|format(stats.total_revenue) }}</h3>
            <span class="stat-trend positive">
                <i class="fas fa-arrow-up"></i> All time
            </span>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-grid">
    <div class="chart-card">
        <div class="chart-header">
            <h3>User Growth (Last 7 Days)</h3>
        </div>
        <div class="chart-body">
            <canvas id="userGrowthChart"></canvas>
        </div>
    </div>
    
    <div class="chart-card">
        <div class="chart-header">
            <h3>Event Categories</h3>
        </div>
        <div class="chart-body">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
</div>

<!-- Tables Section -->
<div class="tables-grid">
    <!-- Recent Events -->
    <!-- Replace static activity feed with Firebase real-time feed -->
<div class="data-card">
    <div class="data-card-header">
        <h3>Live Activity Feed</h3>
        <button onclick="refreshActivities()" class="btn-sm btn-outline">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>
    
    <div class="activity-feed" id="firebase-activity-feed">
        <div class="loading">Loading activities...</div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
// Firebase configuration (get from Firebase Console)
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Listen for real-time updates
db.collection('activities')
  .orderBy('timestamp', 'desc')
  .limit(10)
  .onSnapshot((snapshot) => {
      const feedContainer = document.getElementById('firebase-activity-feed');
      feedContainer.innerHTML = '';
      
      snapshot.forEach((doc) => {
          const activity = doc.data();
          const activityEl = createActivityElement(activity);
          feedContainer.appendChild(activityEl);
      });
  });

function createActivityElement(activity) {
    const div = document.createElement('div');
    div.className = 'activity-item';
    
    const iconClass = getActivityIcon(activity.type);
    const timeAgo = getTimeAgo(activity.timestamp);
    
    div.innerHTML = `
        <div class="activity-icon">
            <i class="${iconClass}"></i>
        </div>
        <div class="activity-content">
            <p class="activity-text">${activity.details}</p>
            <span class="activity-time">${timeAgo}</span>
        </div>
    `;
    
    return div;
}

function getActivityIcon(type) {
    const icons = {
        'registration': 'fas fa-ticket-alt',
        'event_created': 'fas fa-calendar-plus',
        'user_signup': 'fas fa-user-plus',
        'payment': 'fas fa-rupee-sign',
        'cancellation': 'fas fa-times-circle'
    };
    return icons[type] || 'fas fa-circle';
}

function getTimeAgo(timestamp) {
    if (!timestamp) return 'Just now';
    
    const now = new Date();
    const activityDate = timestamp.toDate();
    const diffMs = now - activityDate;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
}

function refreshActivities() {
    // Activities refresh automatically via onSnapshot
    console.log('Activities are live-synced');
}
</script>

        
        <div class="data-table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Event</th>
                        <th>Organizer</th>
                        <th>Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% if recent_events %}
                        {% for event in recent_events[:5] %}
                        <tr>
                            <td>
                                <div class="event-info">
                                    <div class="event-avatar">{{ event.title[0] }}</div>
                                    <span class="event-name">{{ event.title }}</span>
                                </div>
                            </td>
                            <td>{{ event.organizer.name }}</td>
                            <td>{{ event.event_date.strftime('%b %d, %Y') }}</td>
                            <td>
                                <span class="badge badge-{{ 'success' if event.is_active else 'warning' }}">
                                    {{ 'Active' if event.is_active else 'Pending' }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="4" class="no-data">No events yet</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Activity Feed -->
    <div class="data-card">
        <div class="data-card-header">
            <h3>Recent Activity</h3>
        </div>
        
        <div class="activity-feed">
            {% if recent_activity %}
                {% for activity in recent_activity %}
                <div class="activity-item">
                    <div class="activity-icon">
                        <i class="fas fa-circle"></i>
                    </div>
                    <div class="activity-content">
                        <p class="activity-text">{{ activity.action }}</p>
                        <span class="activity-time">{{ activity.time_ago }}</span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="activity-item">
                    <div class="activity-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="activity-content">
                        <p class="activity-text">No recent activity</p>
                        <span class="activity-time">Activity logs will appear here</span>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Dashboard Stats */
.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--bg-elevated);
    border-radius: 12px;
    padding: 24px;
    display: flex;
    gap: 16px;
    align-items: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
}

.stat-icon.blue {
    background: rgba(77, 166, 255, 0.12);
    color: #4da6ff;
}

.stat-icon.purple {
    background: rgba(168, 85, 247, 0.12);
    color: #a855f7;
}

.stat-icon.green {
    background: rgba(16, 185, 129, 0.12);
    color: #10b981;
}

.stat-icon.orange {
    background: rgba(251, 146, 60, 0.12);
    color: #fb923c;
}

.stat-info {
    flex: 1;
}

.stat-label {
    display: block;
    font-size: 12px;
    color: var(--text-tertiary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.stat-number {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -1px;
    margin: 0 0 4px 0;
}

.stat-trend {
    font-size: 13px;
    color: #10b981;
    font-weight: 500;
}

.stat-trend i {
    font-size: 10px;
}

/* Charts Grid */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-card {
    background: var(--bg-elevated);
    border-radius: 12px;
    padding: 24px;
}

.chart-header {
    margin-bottom: 20px;
}

.chart-header h3 {
    font-size: 18px;
    font-weight: 700;
    margin: 0;
}

.chart-body {
    position: relative;
    height: 300px;
}

.chart-body canvas {
    max-height: 100%;
}

/* Tables Grid */
.tables-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
}

.data-card {
    background: var(--bg-elevated);
    border-radius: 12px;
    padding: 24px;
}

.data-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.data-card-header h3 {
    font-size: 18px;
    font-weight: 700;
    margin: 0;
}

.view-all-link {
    color: var(--accent);
    text-decoration: none;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: opacity 0.2s ease;
}

.view-all-link:hover {
    opacity: 0.8;
}

.view-all-link i {
    font-size: 12px;
}

/* Data Table */
.data-table-wrapper {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.data-table th {
    text-align: left;
    padding: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-tertiary);
}

.data-table td {
    padding: 16px 12px;
    font-size: 14px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.03);
}

.data-table tbody tr {
    transition: background 0.2s ease;
}

.data-table tbody tr:hover {
    background: var(--bg-elevated-2);
}

.event-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.event-avatar {
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, var(--accent), #a78bfa);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    flex-shrink: 0;
}

.event-name {
    font-weight: 500;
}

.badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.badge-success {
    background: rgba(16, 185, 129, 0.12);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.badge-warning {
    background: rgba(251, 146, 60, 0.12);
    color: #fb923c;
    border: 1px solid rgba(251, 146, 60, 0.3);
}

.no-data {
    text-align: center;
    padding: 40px 20px !important;
    color: var(--text-tertiary);
}

/* Activity Feed */
.activity-feed {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.activity-item {
    display: flex;
    gap: 12px;
    padding: 16px;
    background: var(--bg-base);
    border-radius: 10px;
    transition: background 0.2s ease;
}

.activity-item:hover {
    background: var(--bg-elevated-2);
}

.activity-icon {
    width: 36px;
    height: 36px;
    background: rgba(77, 166, 255, 0.12);
    color: var(--accent);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 14px;
}

.activity-content {
    flex: 1;
}

.activity-text {
    font-size: 14px;
    font-weight: 500;
    margin: 0 0 4px 0;
}

.activity-time {
    font-size: 12px;
    color: var(--text-tertiary);
}

/* Responsive */
@media (max-width: 1200px) {
    .tables-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .dashboard-stats {
        grid-template-columns: 1fr;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
(function() {
    'use strict';
    
    // Chart data from backend
    const chartData = {
        userGrowthLabels: {{ stats.user_growth_labels | tojson | safe }},
        userGrowthData: {{ stats.user_growth_data | tojson | safe }},
        categoryLabels: {{ stats.category_labels | tojson | safe }},
        categoryData: {{ stats.category_data | tojson | safe }}
    };
    
    // User Growth Chart
    const userGrowthCtx = document.getElementById('userGrowthChart');
    if (userGrowthCtx && chartData.userGrowthLabels.length > 0) {
        new Chart(userGrowthCtx, {
            type: 'line',
            data: {
                labels: chartData.userGrowthLabels,
                datasets: [{
                    label: 'New Users',
                    data: chartData.userGrowthData,
                    borderColor: '#4da6ff',
                    backgroundColor: 'rgba(77, 166, 255, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#4da6ff',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        borderColor: 'rgba(77, 166, 255, 0.5)',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: { 
                            color: '#9ca3af',
                            font: { size: 11 }
                        },
                        grid: { 
                            color: 'rgba(255, 255, 255, 0.05)',
                            drawBorder: false
                        },
                        border: { display: false }
                    },
                    x: {
                        ticks: { 
                            color: '#9ca3af',
                            font: { size: 11 }
                        },
                        grid: { display: false },
                        border: { display: false }
                    }
                }
            }
        });
    }
    
    // Category Chart
    const categoryCtx = document.getElementById('categoryChart');
    if (categoryCtx && chartData.categoryLabels.length > 0) {
        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: chartData.categoryLabels,
                datasets: [{
                    data: chartData.categoryData,
                    backgroundColor: [
                        '#4da6ff',
                        '#a855f7',
                        '#10b981',
                        '#fb923c',
                        '#ef4444',
                        '#06b6d4'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { 
                            color: '#9ca3af',
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        borderColor: 'rgba(77, 166, 255, 0.5)',
                        borderWidth: 1
                    }
                },
                cutout: '65%'
            }
        });
    }
})();
</script>
{% endblock %}
